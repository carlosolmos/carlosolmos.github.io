<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Instrumenting applications with Prometheus | brain dump</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="Instrumenting applications with Prometheus. In this article, we will learn how to create custom metrics for a simple web application and use Prometheus to collect and report on them">
<meta name="generator" content="Hugo 0.92.2" />


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">


  
    
    <link rel="stylesheet" href="/css/custom.css">
  


<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />







  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">‚Üê</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/series">Series</a>
	<a href="/about">About</a>

	

	
	  <a class="button" href="https://carlosolmos.dev/index.xml">Subscribe</a>
	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Instrumenting applications with Prometheus</h1>

    <div class="tip">
        <time datetime="2022-09-24 22:10:52 -0700 PDT">Sep 24, 2022</time>
        <span class="split">
          ¬∑
        </span>
        <span>
          1991 words
        </span>
        <span class="split">
          ¬∑
        </span>
        <span>
          10 minute read
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#site-reliability-engineering">Site Reliability Engineering</a></li>
    <li><a href="#prometheus">Prometheus</a>
      <ul>
        <li><a href="#metrics">Metrics</a></li>
        <li><a href="#client-libraries">Client Libraries</a></li>
      </ul>
    </li>
    <li><a href="#instrumenting-an-application">Instrumenting an Application</a>
      <ul>
        <li><a href="#example-web-application">Example web application</a></li>
        <li><a href="#instrumentation">Instrumentation</a></li>
        <li><a href="#metrics-1">Metrics</a></li>
        <li><a href="#setup-prometheus-service">Setup Prometheus service</a></li>
        <li><a href="#working-with-metrics">Working with Metrics</a></li>
        <li><a href="#up">Up</a></li>
      </ul>
    </li>
    <li><a href="#where-to-go-from-here">Where to go from here?</a></li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <blockquote>
<p><em>&ldquo;What is not defined cannot be measured. What is not measured, cannot be improved. What is not improved, is always degraded&rdquo;.</em>
<em>William Thomson Kelvin</em></p>
</blockquote>
<p>In this article, we will learn how to create custom metrics for a simple web application and use Prometheus to collect and report on them.</p>
<h2 id="site-reliability-engineering">Site Reliability Engineering <a href="#site-reliability-engineering" class="anchor">üîó</a></h2><p>This post is part of a series about Site Reliability Engineering (SRE). In the series, we will talk about different concepts,¬†tools, and techniques to keep a large-scale system healthy. This time we will focus on Monitoring.</p>
<p>Monitoring is one of the pillars of SRE. Having good metrics ‚Äîby good, we mean meaningful, accurate, and up-to-date metrics‚Äî is essential to understand the situation of any system, and to be able to diagnose any problems within it. There is a large body of work on the selection and calculation of relevant metrics. Methodologies like USE, RED, and the Golden Signals, can help you design a simple and effective monitoring strategy. In future articles, we will dive into some of these methods and other good practices.</p>
<p>When tracking system performance, and regardless of the approach we follow, we want to be able to instrument our applications to collect the metrics we need to measure. Some programming languages offer native tools to access real-time information about the state of the run-time environment. The Java Management Extensions (JMX) is a good example. But often, you will want to extend the basic language instrumentation with your metrics. This is where a tool like Prometheus becomes very useful.</p>
<p>Learn more about SRE and Monitoring:</p>
<ul>
<li><a href="https://grafana.com/blog/2018/08/02/the-red-method-how-to-instrument-your-services/" target="_blank" rel="noopener">https://grafana.com/blog/2018/08/02/the-red-method-how-to-instrument-your-services/</a></li>
<li><a href="https://cloud.google.com/sre" target="_blank" rel="noopener">https://cloud.google.com/sre</a></li>
<li><a href="https://www.ibm.com/cloud/learn/site-reliability-engineering" target="_blank" rel="noopener">https://www.ibm.com/cloud/learn/site-reliability-engineering</a></li>
</ul>
<h2 id="prometheus">Prometheus <a href="#prometheus" class="anchor">üîó</a></h2><img src="img/prometheus.gif" width="200px" style="float:right">
<p>The <a href="https://prometheus.io" target="_blank" rel="noopener">official website</a> defines Prometheus as &ldquo;an open-source systems monitoring and alerting toolkit originally built at SoundCloud&rdquo;. Prometheus collects metrics as time series data and offers a query language called PromQL to work with the data. The tool is simple and easy to deploy and operate. It can be used for small and for large-scale systems.</p>
<p>A typical Prometheus solution will include a server that scrapes and stores the data, as well as <a href="https://prometheus.io/docs/instrumenting/clientlibs/" target="_blank" rel="noopener">client libraries</a> ‚Äîin different programming languages‚Äî that produce the metrics within the applications. Optionally, an <a href="https://github.com/prometheus/alertmanager" target="_blank" rel="noopener">alertmanager</a> service can take care of alerts and notifications. When the instrumentation from within the application is not possible ‚Äîif we don&rsquo;t have access to the source code‚Äî Prometheus can use <a href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank" rel="noopener">exporters</a> to collect information.</p>
<h3 id="metrics">Metrics <a href="#metrics" class="anchor">üîó</a></h3><p>Prometheus stores all data as time series data. Every time series is defined by a metric name, and optionally some labels. The metric name defines a system attribute ‚Äîtotal memory used, for example‚Äî and the labels are used to define different dimensions: the specific instance or a specific system component, for example.</p>
<p>Prometheus supports different types of metrics. <strong>Counters</strong>, are used to measure metrics that can only increase or be reset to zero ‚Äîe.g. http_requests_total‚Äî. <strong>Gauge</strong> metrics are used for values that can increase or decrease over time ‚Äîe.g. http_requests_processing_time‚Äî. Other more sophisticated types include the <strong>Histogram</strong>, and the <strong>Summary</strong> observations. To learn more about the Prometheus metrics model: <a href="https://prometheus.io/docs/concepts/metric_types/" target="_blank" rel="noopener">https://prometheus.io/docs/concepts/metric_types/</a></p>
<p><p class="markdown-image"> 
  <img class="zoomable" id="aW1nL21ldHJpY3MucG5n" src="img/metrics.png" alt="metrics"  />  
  <small class="img-note">click to zoom in</small>
</p></p>
<h3 id="client-libraries">Client Libraries <a href="#client-libraries" class="anchor">üîó</a></h3><p>There are Prometheus client libraries for almost every major programming language: <a href="https://prometheus.io/docs/instrumenting/clientlibs" target="_blank" rel="noopener">https://prometheus.io/docs/instrumenting/clientlibs</a>. Some are officially supported, like the ones for Go, Python, Java, Ruby, and Rust; others are provided by third-party open-source developers. Finally, if no library suits your needs, you can implement your own following the standard conventions.</p>
<h2 id="instrumenting-an-application">Instrumenting an Application <a href="#instrumenting-an-application" class="anchor">üîó</a></h2><p>It is time to put these concepts into practice. A simple exercise will take us through the basic concepts:</p>
<ul>
<li>Take a small Python web application and add a few custom metrics using the Prometheus client library.</li>
<li>Set up a local Prometheus server to collect the data.</li>
<li>Use the Prometheus UI to work with the metrics.</li>
</ul>
<div class="note">
<div class="githubref_title">Source Code</div>
<p>
If you are in a hurry, here is github repo with a nice Docker Compose setup and the final code for this exercise
</p>
<a class="download-button" href='https://github.com/carlosolmos/blogresources/tree/main/tales-of-sre/p1-prometheus' target="_new">
    <i data-feather="github"></i> Download Code
</a>
    
</div>
<h3 id="example-web-application">Example web application <a href="#example-web-application" class="anchor">üîó</a></h3><p>Let&rsquo;s begin our exercise with a very simple HTTP application based on Flask: <code>metrics.py</code>. This application has only one endpoint that fetches some remote content and responds with the time it took to retrieve the data. The application code looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">flask</span> <span style="color:#a2f;font-weight:bold">import</span> Flask, jsonify, request
<span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">http.client</span>
<span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">time</span>

app <span style="color:#666">=</span> Flask(__name__)

<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">fetchSomething</span>():
    connection <span style="color:#666">=</span> http<span style="color:#666">.</span>client<span style="color:#666">.</span>HTTPSConnection(<span style="color:#b44">&#34;httpbin.org&#34;</span>)
    connection<span style="color:#666">.</span>request(<span style="color:#b44">&#34;GET&#34;</span>, <span style="color:#b44">&#34;/anything&#34;</span>)
    response <span style="color:#666">=</span> connection<span style="color:#666">.</span>getresponse()
    <span style="color:#a2f">print</span>(<span style="color:#b44">&#34;Status: </span><span style="color:#b68;font-weight:bold">{}</span><span style="color:#b44"> and reason: </span><span style="color:#b68;font-weight:bold">{}</span><span style="color:#b44">&#34;</span><span style="color:#666">.</span>format(response<span style="color:#666">.</span>status, response<span style="color:#666">.</span>reason))
    connection<span style="color:#666">.</span>close()

<span style="color:#a2f">@app</span><span style="color:#666">.</span>route(<span style="color:#b44">&#39;/&#39;</span>, methods <span style="color:#666">=</span> [<span style="color:#b44">&#39;GET&#39;</span>])
<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">home</span>():
    <span style="color:#a2f;font-weight:bold">if</span>(request<span style="color:#666">.</span>method <span style="color:#666">==</span> <span style="color:#b44">&#39;GET&#39;</span>):  
        <span style="color:#080;font-style:italic"># do something and record time</span>
        start <span style="color:#666">=</span> time<span style="color:#666">.</span>time()
        fetchSomething()
        end <span style="color:#666">=</span> time<span style="color:#666">.</span>time()
        t <span style="color:#666">=</span> (end <span style="color:#666">-</span> start)<span style="color:#666">*</span><span style="color:#666">1000</span>
        data <span style="color:#666">=</span> <span style="color:#b44">f</span><span style="color:#b44">&#34;fetch took </span><span style="color:#b68;font-weight:bold">{</span>t<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> ms&#34;</span> 
        <span style="color:#a2f;font-weight:bold">return</span> jsonify({<span style="color:#b44">&#39;msg&#39;</span>: data})
  
  
<span style="color:#080;font-style:italic"># run</span>
<span style="color:#a2f;font-weight:bold">if</span> __name__ <span style="color:#666">==</span> <span style="color:#b44">&#39;__main__&#39;</span>:  
    app<span style="color:#666">.</span>run(debug <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">True</span>)

</code></pre></div><p>Running the application</p>
<p><p class="markdown-image"> 
  <img class="zoomable" id="Li9pbWcvcnVuU2FtcGxlQXBwLnBuZw==" src="./img/runSampleApp.png" alt="Start the app"  />  
  <small class="img-note">click to zoom in</small>
</p></p>
<p>Testing the application</p>
<img class="zoomable" src="./img/sampleAppResponse.png" alt="Test the App" width="400px">
<h3 id="instrumentation">Instrumentation <a href="#instrumentation" class="anchor">üîó</a></h3><p>Now that we have a working sample application, let&rsquo;s add some instrumentation with Prometheus. As we discussed before, Prometheus offers <a href="https://prometheus.io/docs/instrumenting/clientlibs/" target="_blank" rel="noopener">client libraries</a> for the major programming languages. The Prometheus client for Python can be found here: <a href="https://github.com/prometheus/client_python" target="_blank" rel="noopener">https://github.com/prometheus/client_python</a></p>
<p>Adding Prometheus takes two steps:</p>
<ol>
<li>Including the necessary libraries</li>
<li>Expose the <code>/metrics</code> HTTP endpoint for the Prometheus scraper</li>
</ol>
<p>Install the Prometheus Client Library:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">    pip3 install prometheus-client
</code></pre></div><p>Also, install a helper library (<a href="https://pypi.org/project/Werkzeug/" target="_blank" rel="noopener">Werkzeug</a>) to expose the <code>/metrics</code> endpoint through Flask:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">    pip3 install Werkzeug
</code></pre></div><p>Now we can add the code to enable Prometheus in our application:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic"># Import the Prometheus client library and flask helper.</span>
<span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">prometheus_client</span> <span style="color:#a2f;font-weight:bold">import</span> make_wsgi_app
<span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">werkzeug.middleware.dispatcher</span> <span style="color:#a2f;font-weight:bold">import</span> DispatcherMiddleware

<span style="color:#080;font-style:italic"># Add Prometheus WSGI middleware to route /metrics requests</span>
app<span style="color:#666">.</span>wsgi_app <span style="color:#666">=</span> DispatcherMiddleware(app<span style="color:#666">.</span>wsgi_app, {
    <span style="color:#b44">&#39;/metrics&#39;</span>: make_wsgi_app()
})
</code></pre></div><p>The complete code now looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">flask</span> <span style="color:#a2f;font-weight:bold">import</span> Flask, jsonify, request
<span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">http.client</span>
<span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">time</span>
<span style="color:#080;font-style:italic"># Import the Prometheus client library and flask helper.</span>
<span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">prometheus_client</span> <span style="color:#a2f;font-weight:bold">import</span> make_wsgi_app
<span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">werkzeug.middleware.dispatcher</span> <span style="color:#a2f;font-weight:bold">import</span> DispatcherMiddleware


app <span style="color:#666">=</span> Flask(__name__)

<span style="color:#080;font-style:italic"># Add Prometheus WSGI middleware to route /metrics requests</span>
app<span style="color:#666">.</span>wsgi_app <span style="color:#666">=</span> DispatcherMiddleware(app<span style="color:#666">.</span>wsgi_app, {
    <span style="color:#b44">&#39;/metrics&#39;</span>: make_wsgi_app()
})

<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">fetchSomething</span>():
    connection <span style="color:#666">=</span> http<span style="color:#666">.</span>client<span style="color:#666">.</span>HTTPSConnection(<span style="color:#b44">&#34;httpbin.org&#34;</span>)
    connection<span style="color:#666">.</span>request(<span style="color:#b44">&#34;GET&#34;</span>, <span style="color:#b44">&#34;/anything&#34;</span>)
    response <span style="color:#666">=</span> connection<span style="color:#666">.</span>getresponse()
    <span style="color:#a2f">print</span>(<span style="color:#b44">&#34;Status: </span><span style="color:#b68;font-weight:bold">{}</span><span style="color:#b44"> and reason: </span><span style="color:#b68;font-weight:bold">{}</span><span style="color:#b44">&#34;</span><span style="color:#666">.</span>format(response<span style="color:#666">.</span>status, response<span style="color:#666">.</span>reason))
    connection<span style="color:#666">.</span>close()

<span style="color:#a2f">@app</span><span style="color:#666">.</span>route(<span style="color:#b44">&#39;/&#39;</span>, methods <span style="color:#666">=</span> [<span style="color:#b44">&#39;GET&#39;</span>])
<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">home</span>():
    <span style="color:#a2f;font-weight:bold">if</span>(request<span style="color:#666">.</span>method <span style="color:#666">==</span> <span style="color:#b44">&#39;GET&#39;</span>):  
        <span style="color:#080;font-style:italic"># do something and record time</span>
        start <span style="color:#666">=</span> time<span style="color:#666">.</span>time()
        fetchSomething()
        end <span style="color:#666">=</span> time<span style="color:#666">.</span>time()
        t <span style="color:#666">=</span> (end <span style="color:#666">-</span> start)<span style="color:#666">*</span><span style="color:#666">1000</span>
        data <span style="color:#666">=</span> <span style="color:#b44">f</span><span style="color:#b44">&#34;fetch took </span><span style="color:#b68;font-weight:bold">{</span>t<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> ms&#34;</span> 
        <span style="color:#a2f;font-weight:bold">return</span> jsonify({<span style="color:#b44">&#39;msg&#39;</span>: data})
  
  
<span style="color:#080;font-style:italic"># driver function</span>
<span style="color:#a2f;font-weight:bold">if</span> __name__ <span style="color:#666">==</span> <span style="color:#b44">&#39;__main__&#39;</span>:
  
    app<span style="color:#666">.</span>run(debug <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">True</span>)

</code></pre></div><p>We can test the new <code>/metrics</code> endpoint and confirm that it is working. Prometheus automatically collects a few metrics about the application run time environment:</p>
<p><p class="markdown-image"> 
  <img class="zoomable" id="aW1nL3Byb21ldGhldXNCYXNlTWV0cmljcy5wbmc=" src="img/prometheusBaseMetrics.png" alt="prometheus base metrics"  />  
  <small class="img-note">click to zoom in</small>
</p></p>
<h3 id="metrics-1">Metrics <a href="#metrics-1" class="anchor">üîó</a></h3><p>Once we have Prometheus included in our application it is time to add the custom metrics we care about.</p>
<p>We will add a <strong>Counter</strong> for the number of requests to the application and a <strong>Gauge</strong> to track the time it takes to fetch the remote content.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic"># add the metrics classes</span>
<span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">prometheus_client</span> <span style="color:#a2f;font-weight:bold">import</span> Counter, Gauge

<span style="color:#080;font-style:italic"># Define the metrics: one counter and one gauge</span>

<span style="color:#080;font-style:italic"># HELP requests_total Count of requests</span>
<span style="color:#080;font-style:italic"># TYPE requests_total counter</span>
requests_counter <span style="color:#666">=</span> Counter(<span style="color:#b44">&#39;requests&#39;</span>, <span style="color:#b44">&#39;Count of requests&#39;</span>)

<span style="color:#080;font-style:italic"># HELP fetch_time_ms Time to fetch in milliseconds</span>
<span style="color:#080;font-style:italic"># TYPE fetch_time_ms gauge</span>
fetch_time_ms <span style="color:#666">=</span> Gauge(<span style="color:#b44">&#39;fetch_time_ms&#39;</span>, <span style="color:#b44">&#39;Time to fetch in milliseconds&#39;</span>)

</code></pre></div><p>Every time we need to increment our request counter, we call:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic"># increment the request counter</span>
requests_counter<span style="color:#666">.</span>inc()
</code></pre></div><p>And every time we need to update the time gauge, we do:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic"># set the metric value to the time elapsed</span>
fetch_time_ms<span style="color:#666">.</span>set(t)
</code></pre></div><p>Now the application code looks like this, pay attention to the new body of the <code>home()</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">flask</span> <span style="color:#a2f;font-weight:bold">import</span> Flask, jsonify, request
<span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">http.client</span>
<span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">time</span>

<span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">werkzeug.middleware.dispatcher</span> <span style="color:#a2f;font-weight:bold">import</span> DispatcherMiddleware
<span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">prometheus_client</span> <span style="color:#a2f;font-weight:bold">import</span> make_wsgi_app
<span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">prometheus_client</span> <span style="color:#a2f;font-weight:bold">import</span> Counter, Gauge

<span style="color:#080;font-style:italic"># Metrics definition</span>

<span style="color:#080;font-style:italic"># HELP requests_total Count of requests</span>
<span style="color:#080;font-style:italic"># TYPE requests_total counter</span>
requests_counter <span style="color:#666">=</span> Counter(<span style="color:#b44">&#39;requests&#39;</span>, <span style="color:#b44">&#39;Count of requests&#39;</span>)
<span style="color:#080;font-style:italic"># HELP fetch_time_ms Time to fetch in milliseconds</span>
<span style="color:#080;font-style:italic"># TYPE fetch_time_ms gauge</span>
fetch_time_ms <span style="color:#666">=</span> Gauge(<span style="color:#b44">&#39;fetch_time_ms&#39;</span>, <span style="color:#b44">&#39;Time to fetch in milliseconds&#39;</span>)

app <span style="color:#666">=</span> Flask(__name__)

<span style="color:#080;font-style:italic"># Add Prometheus WSGI middleware to route /metrics requests</span>
app<span style="color:#666">.</span>wsgi_app <span style="color:#666">=</span> DispatcherMiddleware(app<span style="color:#666">.</span>wsgi_app, {
    <span style="color:#b44">&#39;/metrics&#39;</span>: make_wsgi_app()
})

<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">fetchSomething</span>():
    connection <span style="color:#666">=</span> http<span style="color:#666">.</span>client<span style="color:#666">.</span>HTTPSConnection(<span style="color:#b44">&#34;httpbin.org&#34;</span>)
    connection<span style="color:#666">.</span>request(<span style="color:#b44">&#34;GET&#34;</span>, <span style="color:#b44">&#34;/anything&#34;</span>)
    response <span style="color:#666">=</span> connection<span style="color:#666">.</span>getresponse()
    <span style="color:#a2f">print</span>(<span style="color:#b44">&#34;Status: </span><span style="color:#b68;font-weight:bold">{}</span><span style="color:#b44"> and reason: </span><span style="color:#b68;font-weight:bold">{}</span><span style="color:#b44">&#34;</span><span style="color:#666">.</span>format(response<span style="color:#666">.</span>status, response<span style="color:#666">.</span>reason))
    connection<span style="color:#666">.</span>close()

<span style="color:#a2f">@app</span><span style="color:#666">.</span>route(<span style="color:#b44">&#39;/&#39;</span>, methods <span style="color:#666">=</span> [<span style="color:#b44">&#39;GET&#39;</span>])
<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">home</span>():
    <span style="color:#a2f;font-weight:bold">if</span>(request<span style="color:#666">.</span>method <span style="color:#666">==</span> <span style="color:#b44">&#39;GET&#39;</span>):  
        <span style="color:#080;font-style:italic"># increment the request counter</span>
        requests_counter<span style="color:#666">.</span>inc()

        <span style="color:#080;font-style:italic"># do something and record time</span>
        start <span style="color:#666">=</span> time<span style="color:#666">.</span>time()
        fetchSomething()
        end <span style="color:#666">=</span> time<span style="color:#666">.</span>time()
        t <span style="color:#666">=</span> (end <span style="color:#666">-</span> start)<span style="color:#666">*</span><span style="color:#666">1000</span>
        
        <span style="color:#080;font-style:italic"># set the metric value to the time elapsed</span>
        fetch_time_ms<span style="color:#666">.</span>set(t)

        data <span style="color:#666">=</span> <span style="color:#b44">f</span><span style="color:#b44">&#34;fetch took </span><span style="color:#b68;font-weight:bold">{</span>t<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> ms&#34;</span> 
        <span style="color:#a2f;font-weight:bold">return</span> jsonify({<span style="color:#b44">&#39;msg&#39;</span>: data})
  
  
<span style="color:#080;font-style:italic"># driver function</span>
<span style="color:#a2f;font-weight:bold">if</span> __name__ <span style="color:#666">==</span> <span style="color:#b44">&#39;__main__&#39;</span>:
  
    app<span style="color:#666">.</span>run(debug <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">True</span>)

</code></pre></div><p>Now, when we call our application and query the <code>/metrics</code> endpoint we can see the new indicators:</p>
<p><p class="markdown-image"> 
  <img class="zoomable" id="aW1nL25ld01ldHJpY3MucG5n" src="img/newMetrics.png" alt="new metrics"  />  
  <small class="img-note">click to zoom in</small>
</p></p>
<h3 id="setup-prometheus-service">Setup Prometheus service <a href="#setup-prometheus-service" class="anchor">üîó</a></h3><p>It is time to launch a Prometheus service to collect our metrics.</p>
<p>There are many ways to <a href="https://prometheus.io/docs/prometheus/latest/installation/" target="_blank" rel="noopener">install Prometheus</a>, we will use Docker for our exercise.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">docker run \
    -p 9090:9090 \
    -v /path/to/prometheus.yml:/etc/prometheus/prometheus.yml \
    prom/prometheus
</code></pre></div><p>Regardless of how you are running the service, you need to prepare the <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/" target="_blank" rel="noopener">configuration file</a> to scrape the metrics from our application. In it, we need to define a <a href="https://prometheus.io/docs/concepts/jobs_instances/" target="_blank" rel="noopener">Job</a> to scrape the metrics from our application.</p>
<p>This is a very simple configuration file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"># my global config
global:
  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).
  external_labels:
    dc: sre1

# A scrape configuration containing two endpoints to scrape:
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any time series scraped from this config.
  # Here it&#39;s Prometheus itself.
  - job_name: &#39;prometheus&#39;   
    static_configs:
    - targets: [&#39;localhost:9090&#39;]
  
  # Scrape our Sample application&#39;s host:port
  - job_name: &#39;pythonapp&#39;   
    static_configs:
    - targets: [&#39;docker.for.mac.host.internal:5000&#39;]
    
</code></pre></div><blockquote>
<p>We do not include the <code>/metrics</code> path in the target since it is assumed by Prometheus.
Because we are running Prometheus inside Docker for macOS, we need to use the host alias <code>docker.for.mac.host.internal</code> to access the application.</p>
</blockquote>
<p>For more configuration options read the official documentation: <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a></p>
<p>Starting the service with Docker:</p>
<p><p class="markdown-image"> 
  <img class="zoomable" id="aW1nL3N0YXJ0RG9ja2VyUHJvbWV0aGV1cy5wbmc=" src="img/startDockerPrometheus.png" alt="starting docker"  />  
  <small class="img-note">click to zoom in</small>
</p></p>
<p>Opening the Prometheus Web UI at <code>http://localhost:9090</code></p>
<p><p class="markdown-image"> 
  <img class="zoomable" id="aW1nL3Byb21ldGhldXNHVUkucG5n" src="img/prometheusGUI.png" alt="open Prometheus UI"  />  
  <small class="img-note">click to zoom in</small>
</p></p>
<h3 id="working-with-metrics">Working with Metrics <a href="#working-with-metrics" class="anchor">üîó</a></h3><p>You can explore, calculate, and graph the different metrics through the Prometheus web UI. The UI includes a handy metrics explorer that simplifies working with the directory of available data.
<p class="markdown-image"> 
  <img class="zoomable" id="aW1nL21ldHJpY3NFeHBsb3Jlci5wbmc=" src="img/metricsExplorer.png" alt="metrics explorer"  />  
  <small class="img-note">click to zoom in</small>
</p></p>
<p>Prometheus offers a rich querying language called PromQL that allows you to work with the metrics in different dimensions.
You can find detailed documentation on PromQL on the official website: <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/querying/basics/</a>. Right now we will focus on a couple of basic queries to inspect the state of our application:</p>
<p>Simple metric selection. Shows the value for a particular metric, filtered by a set of labels assigned by Prometheus.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">metric{label=val, label=val,...}
</code></pre></div><p>Rate of change of a metric. Typically used for simple counters when the velocity of change is more relevant than the value itself.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">rate(metric{label=val, label=val,...}[time period])
</code></pre></div><p>Let&rsquo;s look at the metrics from our application:</p>
<p><em>The time it took to fetch remote content</em></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">fetch_time_ms{job=&#34;pythonapp&#34;}
</code></pre></div><p><p class="markdown-image"> 
  <img class="zoomable" id="aW1nL2ZldGNoVGltZU1zLnBuZw==" src="img/fetchTimeMs.png" alt="fetch time metric"  />  
  <small class="img-note">click to zoom in</small>
</p></p>
<blockquote>
<p>Notice the label <code>job</code>, equal to the &ldquo;job_name&rdquo; value we gave to the scrapping target in the configuration file. The second label <code>instance</code> is equal to the source host of the metrics. These labels are automatically assigned by Prometheus.</p>
</blockquote>
<p><em>Total Number of Requests</em></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">requests_total{job=&#34;pythonapp&#34;}
</code></pre></div><p><p class="markdown-image"> 
  <img class="zoomable" id="aW1nL3JlcXVlc3RzVG90YWwucG5n" src="img/requestsTotal.png" alt="requests metric"  />  
  <small class="img-note">click to zoom in</small>
</p></p>
<p><em>Rate of Requests (RPS) for a 5m interval</em></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">rate(requests_total{job=&#34;pythonapp&#34;}[5m])
</code></pre></div><p><p class="markdown-image"> 
  <img class="zoomable" id="aW1nL3Jwcy5wbmc=" src="img/rps.png" alt="rps"  />  
  <small class="img-note">click to zoom in</small>
</p></p>
<h3 id="up">Up <a href="#up" class="anchor">üîó</a></h3><p><code>Up</code> is a special metric that Prometheus creates automatically for every target. If it is possible to assume that when the <code>/metrics</code> endpoint is accessible the entire application is running, then you get a free heartbeat signal by plugin Prometheus into it.</p>
<p><p class="markdown-image"> 
  <img class="zoomable" id="aW1nL3VwLnBuZw==" src="img/up.png" alt="up"  />  
  <small class="img-note">click to zoom in</small>
</p></p>
<h2 id="where-to-go-from-here">Where to go from here? <a href="#where-to-go-from-here" class="anchor">üîó</a></h2><p>Hopefully, after this exercise, you should be able to instrument your application with basic metrics. The same pattern applies to <a href="https://prometheus.io/docs/instrumenting/clientlibs/" target="_blank" rel="noopener">other languages</a>. Give it a try following the guides from the client repositories.</p>
<p>We have just scratched the surface of what Prometheus has to offer as a monitoring solution. If you liked what you saw so far, go and take a look at the <a href="https://prometheus.io/docs/introduction/overview/" target="_blank" rel="noopener">official documentation</a> on other components.
Other posts in this series will touch on other Prometheus features like Exporters, the AlertManager, Custom Metric Rules, as well as SRE concepts like Metrics best practices, and the use of <a href="https://grafana.com/oss/grafana/?pg=oss-graf&amp;plcmt=resources" target="_blank" rel="noopener">Grafana</a> for metrics visualization.</p>

    </div>

    
        <div class="tags">
            
                <a href="https://carlosolmos.dev/tags/sre">sre</a>
            
                <a href="https://carlosolmos.dev/tags/prometheus">prometheus</a>
            
                <a href="https://carlosolmos.dev/tags/metrics">metrics</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/carlosolmos/" rel="me" target="_blank">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><rect x="0" fill="none" width="24" height="24"/><g><path d="M12 2C6.477 2 2 6.477 2 12c0 4.419 2.865 8.166 6.839 9.489.5.09.682-.218.682-.484 0-.236-.009-.866-.014-1.699-2.782.602-3.369-1.34-3.369-1.34-.455-1.157-1.11-1.465-1.11-1.465-.909-.62.069-.608.069-.608 1.004.071 1.532 1.03 1.532 1.03.891 1.529 2.341 1.089 2.91.833.091-.647.349-1.086.635-1.337-2.22-.251-4.555-1.111-4.555-4.943 0-1.091.39-1.984 1.03-2.682-.103-.254-.447-1.27.097-2.646 0 0 .84-.269 2.75 1.025A9.548 9.548 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.748-1.025 2.748-1.025.546 1.376.202 2.394.1 2.646.64.699 1.026 1.591 1.026 2.682 0 3.841-2.337 4.687-4.565 4.935.359.307.679.917.679 1.852 0 1.335-.012 2.415-.012 2.741 0 .269.18.579.688.481A9.997 9.997 0 0022 12c0-5.523-4.477-10-10-10z" fill="#bbbbbb"/></g></svg>
    </a>

    <a class="symbol" href="https://www.linkedin.com/in/carlosaolmos" rel="me" target="_blank">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><rect x="0" fill="none" width="24" height="24"/><g><path d="M19.7 3H4.3A1.3 1.3 0 003 4.3v15.4A1.3 1.3 0 004.3 21h15.4a1.3 1.3 0 001.3-1.3V4.3A1.3 1.3 0 0019.7 3zM8.339 18.338H5.667v-8.59h2.672v8.59zM7.004 8.574a1.548 1.548 0 11-.002-3.096 1.548 1.548 0 01.002 3.096zm11.335 9.764H15.67v-4.177c0-.996-.017-2.278-1.387-2.278-1.389 0-1.601 1.086-1.601 2.206v4.249h-2.667v-8.59h2.559v1.174h.037c.356-.675 1.227-1.387 2.526-1.387 2.703 0 3.203 1.779 3.203 4.092v4.711z" fill="#bbbbbb"/></g></svg>
    </a>


</div>

    

    <div class="copyright">
    
       ¬© Copyright 
       2022 
       <span class="split">
        Made with <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       by Carlos A Olmos
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Based on Theme mini By <a href='https://github.com/nodejh/hugo-theme-cactus-plus'>nodejh</a>
      </div>
    
</footer>
<div id="lightbox"></div>

    
        
        <script src="https://carlosolmos.dev/js/custom.js"></script>
    

<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script>
    
  feather.replace()
</script>
  </body>
</html>
